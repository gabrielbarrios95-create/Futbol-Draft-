<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Draft de Jugadores</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loading-spinner {
            border-top-color: transparent;
            -webkit-animation: spinner-border 0.75s linear infinite;
            animation: spinner-border 0.75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-800 font-sans leading-normal tracking-normal text-white">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 ease-in-out">
        <div class="flex flex-col items-center">
            <div class="loading-spinner w-12 h-12 rounded-full border-4 border-white-500 border-solid"></div>
            <p class="mt-4 text-white text-lg">Cargando...</p>
        </div>
    </div>
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-white mb-2">Simulador de Draft de Jugadores</h1>
            <p class="text-gray-400">Crea equipos y compite en un draft misterioso en tiempo real.</p>
            <p id="user-info" class="text-xs text-gray-500 mt-2">ID de Usuario: <span id="user-id"></span></p>
        </header>

        <div id="message-box" class="hidden text-center"></div>
        
        <!-- Controles para crear equipos -->
        <div class="bg-gray-900 rounded-lg shadow-xl p-6 border border-gray-700 mb-8">
            <h2 class="text-xl font-bold text-white mb-4">Crea tu equipo</h2>
            <form id="add-team-form" class="flex flex-col md:flex-row gap-4">
                <input type="text" id="new-team-name" required placeholder="Nombre del Equipo" class="flex-1 rounded-md bg-gray-700 text-white border-gray-600 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50">
                <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-700 hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600 transition duration-300">
                    Agregar Equipo
                </button>
            </form>
        </div>

        <!-- Botón para iniciar el draft -->
        <div class="flex justify-center mt-6 mb-8">
            <button id="start-draft-btn" class="hidden py-3 px-8 bg-blue-700 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-blue-800 transition duration-300">
                <i class="fas fa-play-circle mr-2"></i> Iniciar Draft
            </button>
        </div>
        
        <!-- Sección de la subasta -->
        <div id="auction-area" class="hidden bg-gray-700 rounded-lg shadow-xl p-8 text-center border border-gray-600 mb-8">
            <h2 class="text-3xl font-extrabold text-white mb-4">¡Subasta en curso!</h2>
            <div id="timer-display" class="text-5xl font-extrabold text-red-400 mb-4"></div>
            <div class="flex flex-col md:flex-row justify-center items-center md:space-x-8 space-y-4 md:space-y-0">
                <div id="auction-player-card" class="bg-gray-900 p-6 rounded-lg shadow-md w-full max-w-sm">
                    <!-- Player info will be rendered here -->
                </div>
                <div id="bid-info" class="bg-gray-900 p-6 rounded-lg shadow-md w-full max-w-sm">
                    <!-- Bid info will be rendered here -->
                </div>
            </div>
            
            <div class="mt-8">
                <label for="team-select" class="text-gray-300 font-medium mb-2 block">Selecciona tu equipo:</label>
                <select id="team-select" class="w-full md:w-1/2 mx-auto mb-4 rounded-md bg-gray-800 text-white border-gray-700 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50"></select>
            </div>
            
            <div id="bid-buttons" class="flex flex-col md:flex-row justify-center gap-4 mt-4">
                <button id="bid-initial-btn" data-bid="initial" class="py-3 px-6 bg-green-500 text-black font-bold text-lg rounded-lg shadow-lg hover:bg-green-600 transition duration-300">
                    Pujar
                </button>
                <button id="bid-3m-btn" data-bid="3000000" class="py-3 px-6 bg-green-700 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-green-800 transition duration-300">
                    Pujar +3M
                </button>
                <button id="bid-8m-btn" data-bid="8000000" class="py-3 px-6 bg-green-900 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-green-950 transition duration-300">
                    Pujar +8M
                </button>
                <button id="hint-btn" class="py-3 px-6 bg-red-600 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-red-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    Pista (<span id="hints-left">2</span>)
                </button>
            </div>
        </div>

        <!-- Listado de jugadores de cada equipo -->
        <div class="bg-gray-900 rounded-lg shadow-xl p-6 border border-gray-700">
            <h2 class="text-2xl font-bold text-white mb-4">Equipos y Jugadores</h2>
            <div id="teams-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Team cards will be rendered here -->
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config and global variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Data de los jugadores ---
        const playersData = [
            // Defensas (30)
            { name: 'Virgil', lastName: 'van Dijk', position: 'DFC', nationality: 'NED', value: 85000000 },
            { name: 'Rúben', lastName: 'Dias', position: 'DFC', nationality: 'POR', value: 80000000 },
            { name: 'Kyle', lastName: 'Walker', position: 'LD', nationality: 'ENG', value: 35000000 },
            { name: 'Ronald', lastName: 'Araujo', position: 'DFC', nationality: 'URU', value: 70000000 },
            { name: 'Jules', lastName: 'Koundé', position: 'DFC', nationality: 'FRA', value: 65000000 },
            { name: 'Éder', lastName: 'Militão', position: 'DFC', nationality: 'BRA', value: 75000000 },
            { name: 'Matthijs', lastName: 'de Ligt', position: 'DFC', nationality: 'NED', value: 70000000 },
            { name: 'Marquinhos', lastName: '', position: 'DFC', nationality: 'BRA', value: 75000000 },
            { name: 'Joško', lastName: 'Gvardiol', position: 'DFC', nationality: 'CRO', value: 75000000 },
            { name: 'Antonio', lastName: 'Rüdiger', position: 'DFC', nationality: 'GER', value: 50000000 },
            { name: 'William', lastName: 'Saliba', position: 'DFC', nationality: 'FRA', value: 70000000 },
            { name: 'Theo', lastName: 'Hernández', position: 'LI', nationality: 'FRA', value: 60000000 },
            { name: 'Alphonso', lastName: 'Davies', position: 'LI', nationality: 'CAN', value: 55000000 },
            { name: 'Alejandro', lastName: 'Balde', position: 'LI', nationality: 'ESP', value: 50000000 },
            { name: 'Manuel', lastName: 'Akanji', position: 'DFC', nationality: 'SUI', value: 45000000 },
            { name: 'David', lastName: 'Alaba', position: 'DFC', nationality: 'AUT', value: 40000000 },
            { name: 'Ben', lastName: 'White', position: 'LD', nationality: 'ENG', value: 55000000 },
            { name: 'John', lastName: 'Stones', position: 'DFC', nationality: 'ENG', value: 45000000 },
            { name: 'Lisandro', lastName: 'Martínez', position: 'DFC', nationality: 'ARG', value: 50000000 },
            { name: 'Reece', lastName: 'James', position: 'LD', nationality: 'ENG', value: 60000000 },
            { name: 'Andrew', lastName: 'Robertson', position: 'LI', nationality: 'SCO', value: 40000000 },
            { name: 'Fikayo', lastName: 'Tomori', position: 'DFC', nationality: 'ENG', value: 40000000 },
            { name: 'Milan', lastName: 'Škriniar', position: 'DFC', nationality: 'SVK', value: 45000000 },
            { name: 'Raphaël', lastName: 'Varane', position: 'DFC', nationality: 'FRA', value: 35000000 },
            { name: 'Dayot', lastName: 'Upamecano', position: 'DFC', nationality: 'FRA', value: 50000000 },
            { name: 'Lucas', lastName: 'Hernández', position: 'LI', nationality: 'FRA', value: 45000000 },
            { name: 'Nicolò', lastName: 'Barella', position: 'MC', nationality: 'ITA', value: 75000000 },
            { name: 'Federico', lastName: 'Valverde', position: 'MCO', nationality: 'URU', value: 100000000 },
            { name: 'Bernardo', lastName: 'Silva', position: 'MCO', nationality: 'POR', value: 80000000 },
            { name: 'Jude', lastName: 'Bellingham', position: 'MCO', nationality: 'ENG', value: 180000000 },

            // Mediocampistas (35)
            { name: 'Kevin', lastName: 'De Bruyne', position: 'MCO', nationality: 'BEL', value: 70000000 },
            { name: 'Rodri', lastName: '', position: 'MCD', nationality: 'ESP', value: 110000000 },
            { name: 'Frenkie', lastName: 'de Jong', position: 'MC', nationality: 'NED', value: 80000000 },
            { name: 'Joshua', lastName: 'Kimmich', position: 'MCD', nationality: 'GER', value: 75000000 },
            { name: 'Toni', lastName: 'Kroos', position: 'MC', nationality: 'GER', value: 12000000 },
            { name: 'Luka', lastName: 'Modrić', position: 'MC', nationality: 'CRO', value: 10000000 },
            { name: 'Bruno', lastName: 'Fernandes', position: 'MCO', nationality: 'POR', value: 70000000 },
            { name: 'Martin', lastName: 'Ødegaard', position: 'MCO', nationality: 'NOR', value: 90000000 },
            { name: 'Casemiro', lastName: '', position: 'MCD', nationality: 'BRA', value: 40000000 },
            { name: 'Declan', lastName: 'Rice', position: 'MCD', nationality: 'ENG', value: 110000000 },
            { name: 'Pedri', lastName: '', position: 'MC', nationality: 'ESP', value: 90000000 },
            { name: 'Gavi', lastName: '', position: 'MC', nationality: 'ESP', value: 70000000 },
            { name: 'Ilkay', lastName: 'Gündoğan', position: 'MC', nationality: 'GER', value: 20000000 },
            { name: 'Florian', lastName: 'Wirtz', position: 'MCO', nationality: 'GER', value: 100000000 },
            { name: 'Jamal', lastName: 'Musiala', position: 'MCO', nationality: 'GER', value: 110000000 },
            { name: 'Alexis', lastName: 'Mac Allister', position: 'MC', nationality: 'ARG', value: 70000000 },
            { name: 'Enzo', lastName: 'Fernández', position: 'MC', nationality: 'ARG', value: 80000000 },
            { name: 'João', lastName: 'Palhinha', position: 'MCD', nationality: 'POR', value: 55000000 },
            { name: 'Sandro', lastName: 'Tonali', position: 'MCD', nationality: 'ITA', value: 50000000 },
            { name: 'Aurélien', lastName: 'Tchouaméni', position: 'MCD', nationality: 'FRA', value: 80000000 },
            { name: 'Mason', lastName: 'Mount', position: 'MCO', nationality: 'ENG', value: 45000000 },
            { name: 'Sergej', lastName: 'Milinković-Savić', position: 'MC', nationality: 'SRB', value: 25000000 },
            { name: 'Eduardo', lastName: 'Camavinga', position: 'MCD', nationality: 'FRA', value: 90000000 },
            { name: 'Dani', lastName: 'Olmo', position: 'MCO', nationality: 'ESP', value: 50000000 },
            { name: 'Federico', lastName: 'Chiesa', position: 'MD', nationality: 'ITA', value: 40000000 },
            { name: 'Gavi', lastName: 'Paez', position: 'MC', nationality: 'ESP', value: 70000000 },
            { name: 'Xavi', lastName: 'Simons', position: 'MCO', nationality: 'NED', value: 80000000 },
            { name: 'Dominik', lastName: 'Szoboszlai', position: 'MCO', nationality: 'HUN', value: 75000000 },
            { name: 'Matteo', lastName: 'Guendouzi', position: 'MC', nationality: 'FRA', value: 25000000 },
            { name: 'Nicolò', lastName: 'Zaniolo', position: 'MCO', nationality: 'ITA', value: 25000000 },
            { name: 'Youri', lastName: 'Tielemans', position: 'MC', nationality: 'BEL', value: 20000000 },
            { name: 'Thomas', lastName: 'Partey', position: 'MCD', nationality: 'GHA', value: 30000000 },
            { name: 'Franck', lastName: 'Kessié', position: 'MC', nationality: 'CIV', value: 25000000 },
            { name: 'Giorgian', lastName: 'De Arrascaeta', position: 'MCO', nationality: 'URU', value: 15000000 },
            { name: 'James', lastName: 'Maddison', position: 'MCO', nationality: 'ENG', value: 70000000 },

            // Delanteros (25)
            { name: 'Kylian', lastName: 'Mbappé', position: 'DC', nationality: 'FRA', value: 180000000 },
            { name: 'Erling', lastName: 'Haaland', position: 'DC', nationality: 'NOR', value: 180000000 },
            { name: 'Vinícius', lastName: 'Júnior', position: 'EI', nationality: 'BRA', value: 150000000 },
            { name: 'Victor', lastName: 'Osimhen', position: 'DC', nationality: 'NGA', value: 120000000 },
            { name: 'Mohamed', lastName: 'Salah', position: 'ED', nationality: 'EGY', value: 65000000 },
            { name: 'Harry', lastName: 'Kane', position: 'DC', nationality: 'ENG', value: 100000000 },
            { name: 'Robert', lastName: 'Lewandowski', position: 'DC', nationality: 'POL', value: 20000000 },
            { name: 'Antoine', lastName: 'Griezmann', position: 'SD', nationality: 'FRA', value: 25000000 },
            { name: 'Karim', lastName: 'Benzema', position: 'DC', nationality: 'FRA', value: 15000000 },
            { name: 'Rafael', lastName: 'Leão', position: 'EI', nationality: 'POR', value: 90000000 },
            { name: 'Bukayo', lastName: 'Saka', position: 'ED', nationality: 'ENG', value: 130000000 },
            { name: 'Phil', lastName: 'Foden', position: 'MCO', nationality: 'ENG', value: 110000000 },
            { name: 'Khvicha', lastName: 'Kvaratskhelia', position: 'EI', nationality: 'GEO', value: 85000000 },
            { name: 'Federico', lastName: 'Chiesa', position: 'EI', nationality: 'ITA', value: 40000000 },
            { name: 'Jack', lastName: 'Grealish', position: 'EI', nationality: 'ENG', value: 70000000 },
            { name: 'Raphinha', lastName: '', position: 'ED', nationality: 'BRA', value: 50000000 },
            { name: 'Diogo', lastName: 'Jota', position: 'DC', nationality: 'POR', value: 50000000 },
            { name: 'Son', lastName: 'Heung-Min', position: 'EI', nationality: 'KOR', value: 50000000 },
            { name: 'Marcus', lastName: 'Rashford', position: 'EI', nationality: 'ENG', value: 75000000 },
            { name: 'Dusan', lastName: 'Vlahovic', position: 'DC', nationality: 'SRB', value: 60000000 },
            { name: 'Gabriel', lastName: 'Jesus', position: 'DC', nationality: 'BRA', value: 70000000 },
            { name: 'Christopher', lastName: 'Nkunku', position: 'MCO', nationality: 'FRA', value: 80000000 },
            { name: 'Aleksandar', lastName: 'Mitrovic', position: 'DC', nationality: 'SRB', value: 28000000 },
            { name: 'Álvaro', lastName: 'Morata', position: 'DC', nationality: 'ESP', value: 20000000 },
            { name: 'Ferran', lastName: 'Torres', position: 'ED', nationality: 'ESP', value: 25000000 },

            // Arqueros (15)
            { name: 'Thibaut', lastName: 'Courtois', position: 'POR', nationality: 'BEL', value: 35000000 },
            { name: 'Alisson', lastName: 'Becker', position: 'POR', nationality: 'BRA', value: 35000000 },
            { name: 'Ederson', lastName: 'Moraes', position: 'POR', nationality: 'BRA', value: 40000000 },
            { name: 'Marc-André', lastName: 'ter Stegen', position: 'POR', nationality: 'GER', value: 35000000 },
            { name: 'Jan', lastName: 'Oblak', position: 'POR', nationality: 'SLO', value: 30000000 },
            { name: 'Manuel', lastName: 'Neuer', position: 'POR', nationality: 'GER', value: 7000000 },
            { name: 'Gianluigi', lastName: 'Donnarumma', position: 'POR', nationality: 'ITA', value: 45000000 },
            { name: 'Mike', lastName: 'Maignan', position: 'POR', nationality: 'FRA', value: 45000000 },
            { name: 'André', lastName: 'Onana', position: 'POR', nationality: 'CMR', value: 40000000 },
            { name: 'Aaron', lastName: 'Ramsdale', position: 'POR', nationality: 'ENG', value: 38000000 },
            { name: 'Diogo', lastName: 'Costa', position: 'POR', nationality: 'POR', value: 45000000 },
            { name: 'Gregor', lastName: 'Kobel', position: 'POR', nationality: 'SUI', value: 40000000 },
            { name: 'Álex', lastName: 'Remiro', position: 'POR', nationality: 'ESP', value: 25000000 },
            { name: 'David', lastName: 'Raya', position: 'POR', nationality: 'ESP', value: 35000000 },
            { name: 'Wojciech', lastName: 'Szczesny', position: 'POR', nationality: 'POL', value: 15000000 }
        ];

        // UI elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const teamForm = document.getElementById('add-team-form');
        const teamNameInput = document.getElementById('new-team-name');
        const startDraftBtn = document.getElementById('start-draft-btn');
        const auctionArea = document.getElementById('auction-area');
        const playerCard = document.getElementById('auction-player-card');
        const bidInfo = document.getElementById('bid-info');
        const bidButtons = document.getElementById('bid-buttons');
        const teamsListContainer = document.getElementById('teams-list-container');
        const messageBox = document.getElementById('message-box');
        const hintBtn = document.getElementById('hint-btn');
        const hintsLeftSpan = document.getElementById('hints-left');
        const initialBidBtn = document.getElementById('bid-initial-btn');
        const teamSelect = document.getElementById('team-select');
        const userIdSpan = document.getElementById('user-id');

        // State variables
        let app, db, auth;
        let userId = null;
        let teams = [];
        let currentAuction = {
            player: null,
            currentBid: 0,
            currentBidderId: null,
            timer: 30,
            interval: null,
            hintsUsed: 0,
        };
        const DRAFT_STATE_DOC_ID = 'draftState';
        const PLAYERS_POOL_DOC_ID = 'playersPool';

        // Event Listeners
        window.onload = async () => {
            setLogLevel('debug');
            initializeApp(firebaseConfig);
            auth = getAuth();
            db = getFirestore();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdSpan.textContent = userId;
                    // Listen to all teams in the public collection
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/teams`), (snapshot) => {
                        teams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderTeamsList();
                        checkDraftReadiness();
                    });

                    // Listen to the shared draft state
                    onSnapshot(doc(db, `artifacts/${appId}/public/data/draft`, DRAFT_STATE_DOC_ID), (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (JSON.stringify(data) !== JSON.stringify(currentAuction)) {
                                currentAuction = data;
                                renderAuctionUI();
                                if (currentAuction.timer > 0) {
                                    startTimer();
                                } else {
                                    clearInterval(currentAuction.interval);
                                }
                            }
                        } else {
                            // No draft state exists, reset UI
                            auctionArea.classList.add('hidden');
                        }
                    });

                    loadingOverlay.classList.add('hidden');
                }
            });

            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (e) {
                    console.error("Firebase Auth Error:", e);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }
        };

        teamForm.addEventListener('submit', handleAddTeam);
        startDraftBtn.addEventListener('click', startDraft);
        bidButtons.addEventListener('click', handleBid);
        hintBtn.addEventListener('click', handleHint);

        // Funciones principales
        async function handleAddTeam(event) {
            event.preventDefault();
            const teamName = teamNameInput.value.trim();
            if (!teamName) {
                showMessage("Por favor, introduce un nombre para el equipo.", 'error');
                return;
            }

            const teamExists = teams.find(t => t.name.toLowerCase() === teamName.toLowerCase());
            if (teamExists) {
                showMessage("Este nombre de equipo ya existe.", 'error');
                return;
            }

            const newTeam = {
                name: teamName,
                ownerId: userId,
                players: [],
                budget: 1500000000,
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/teams`), newTeam);
                teamNameInput.value = '';
                showMessage(`Equipo "${teamName}" agregado con éxito.`);
            } catch (e) {
                console.error("Error adding team:", e);
                showMessage("Error al agregar el equipo.", 'error');
            }
        }

        async function startDraft() {
            if (teams.length < 1) {
                showMessage("Debes crear al menos un equipo para iniciar el draft.", 'error');
                return;
            }
            startDraftBtn.classList.add('hidden');
            auctionArea.classList.remove('hidden');

            try {
                // Shuffle players and create initial pool
                const playersPool = shuffleArray(playersData);
                await setDoc(doc(db, `artifacts/${appId}/public/data/draft`, PLAYERS_POOL_DOC_ID), { players: playersPool });
                
                await nextAuction();
            } catch (e) {
                console.error("Error starting draft:", e);
                showMessage("Error al iniciar el draft.", 'error');
            }
        }

        async function nextAuction() {
            try {
                const poolDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/draft`, PLAYERS_POOL_DOC_ID));
                const playersPool = poolDoc.data()?.players || [];
                
                if (playersPool.length === 0 || teams.every(team => team.players.length >= 22)) {
                    showMessage("El draft ha terminado.", 'success');
                    await setDoc(doc(db, `artifacts/${appId}/public/data/draft`, DRAFT_STATE_DOC_ID), { status: 'finished' });
                    return;
                }

                const nextPlayer = playersPool.shift();
                await setDoc(doc(db, `artifacts/${appId}/public/data/draft`, PLAYERS_POOL_DOC_ID), { players: playersPool });
                
                const newAuctionState = {
                    player: nextPlayer,
                    currentBid: nextPlayer.value,
                    currentBidderId: null,
                    timer: 30,
                    hintsUsed: 0,
                    lettersToShow: 1,
                };
                await setDoc(doc(db, `artifacts/${appId}/public/data/draft`, DRAFT_STATE_DOC_ID), newAuctionState);
            } catch (e) {
                console.error("Error moving to next auction:", e);
                showMessage("Error al pasar a la siguiente subasta.", 'error');
            }
        }

        async function handleBid(event) {
            const button = event.target.closest('button');
            if (!button || button.id === 'hint-btn') return;
            
            const teamId = teamSelect.value;
            const biddingTeam = teams.find(t => t.id === teamId);

            if (!biddingTeam) {
                showMessage("Selecciona tu equipo para pujar.", 'error');
                return;
            }
            if (biddingTeam.ownerId !== userId) {
                showMessage("No eres el dueño de este equipo.", 'error');
                return;
            }

            let newBid = 0;
            if (button.id === 'bid-initial-btn') {
                newBid = currentAuction.player.value;
            } else {
                newBid = currentAuction.currentBid + (button.dataset.bid === '3000000' ? 3000000 : 8000000);
            }

            if (newBid <= currentAuction.currentBid) {
                showMessage("Tu puja debe ser mayor que la puja actual.", 'error');
                return;
            }

            if (biddingTeam.budget < newBid) {
                showMessage(`Presupuesto insuficiente. Te faltan ${formatCurrency(newBid - biddingTeam.budget)}.`, 'error');
                return;
            }
            if (biddingTeam.players.length >= 22) {
                showMessage("Tu equipo ya está lleno (22 jugadores).", 'error');
                return;
            }

            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/draft`, DRAFT_STATE_DOC_ID), {
                    currentBid: newBid,
                    currentBidderId: biddingTeam.id,
                    timer: 30, // Reset timer on new bid
                });
            } catch (e) {
                console.error("Error placing bid:", e);
                showMessage("Error al realizar la puja.", 'error');
            }
        }

        async function handleHint() {
            if (currentAuction.hintsUsed >= 2) {
                hintBtn.disabled = true;
                return;
            }

            try {
                const newHintsUsed = currentAuction.hintsUsed + 1;
                const newLettersToShow = currentAuction.lettersToShow + 2;
                const newPlayerValue = currentAuction.player.value + 5000000;
                let newBid = currentAuction.currentBid;

                if (newBid < newPlayerValue) {
                    newBid = newPlayerValue;
                }

                await updateDoc(doc(db, `artifacts/${appId}/public/data/draft`, DRAFT_STATE_DOC_ID), {
                    hintsUsed: newHintsUsed,
                    lettersToShow: newLettersToShow,
                    "player.value": newPlayerValue,
                    currentBid: newBid,
                });

                if (newHintsUsed >= 2) {
                    hintBtn.disabled = true;
                }
            } catch (e) {
                console.error("Error using hint:", e);
                showMessage("Error al usar la pista.", 'error');
            }
        }

        async function endAuction() {
            if (currentAuction.currentBidderId) {
                const winningTeamRef = doc(db, `artifacts/${appId}/public/data/teams`, currentAuction.currentBidderId);
                const winningTeamSnap = await getDoc(winningTeamRef);
                const winningTeam = winningTeamSnap.data();

                if (winningTeam) {
                    const updatedPlayers = [...winningTeam.players, currentAuction.player];
                    const updatedBudget = winningTeam.budget - currentAuction.currentBid;
                    
                    try {
                        await updateDoc(winningTeamRef, {
                            players: updatedPlayers,
                            budget: updatedBudget,
                        });
                        showMessage(`¡${winningTeam.name} ha ganado la subasta por ${currentAuction.player.name} ${currentAuction.player.lastName}!`, 'success');
                    } catch (e) {
                        console.error("Error assigning player:", e);
                        showMessage("Error al asignar el jugador al equipo.", 'error');
                    }
                }
            } else {
                showMessage("La subasta terminó sin pujas. El jugador regresa a la piscina.", 'error');
            }
            
            setTimeout(async () => {
                await nextAuction();
            }, 3000); // 3-second pause
        }

        function startTimer() {
            if (currentAuction.interval) clearInterval(currentAuction.interval);
            const timerDisplay = document.getElementById('timer-display');
            
            const timerDocRef = doc(db, `artifacts/${appId}/public/data/draft`, DRAFT_STATE_DOC_ID);

            const intervalId = setInterval(async () => {
                const docSnap = await getDoc(timerDocRef);
                const currentTimer = docSnap.data()?.timer || 0;
                
                if (currentTimer <= 1) {
                    clearInterval(intervalId);
                    endAuction();
                    return;
                }
                
                try {
                    await updateDoc(timerDocRef, { timer: currentTimer - 1 });
                } catch (e) {
                    console.error("Error updating timer:", e);
                    clearInterval(intervalId); // Stop timer on error
                }
            }, 1000);
            currentAuction.interval = intervalId;
        }

        // Funciones de renderizado
        function renderTeamsList() {
            teamsListContainer.innerHTML = '';
            teamSelect.innerHTML = `<option value="">Selecciona tu equipo</option>`;
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                teamSelect.appendChild(option);

                const teamCard = document.createElement('div');
                teamCard.className = 'bg-gray-900 rounded-lg shadow-md p-6';
                teamCard.innerHTML = `
                    <h3 class="text-xl font-bold text-white">${team.name} <span class="text-sm font-normal text-gray-400">(${team.players.length}/22)</span></h3>
                    <p class="text-sm text-gray-400 mb-4">Presupuesto: <span class="font-bold text-green-400">${formatCurrency(team.budget)}</span></p>
                    <ul class="list-disc list-inside space-y-1 text-gray-300">
                        ${team.players.length > 0 ? team.players.map(p => `<li>${p.name} ${p.lastName} (${p.position})</li>`).join('') : '<li>Sin jugadores aún.</li>'}
                    </ul>
                `;
                teamsListContainer.appendChild(teamCard);
            });
        }

        function renderAuctionUI() {
            const player = currentAuction.player;
            if (!player) {
                auctionArea.classList.add('hidden');
                return;
            }
            auctionArea.classList.remove('hidden');

            const displayedFirstName = player.name.substring(0, currentAuction.lettersToShow);
            const displayedLastName = player.lastName.substring(0, currentAuction.lettersToShow);
            const dots = '...';

            playerCard.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="text-5xl font-bold text-white mb-2">
                        ${displayedFirstName}${dots} ${displayedLastName}${dots}
                    </div>
                    <img src="${getFlagUrl(player.nationality)}" alt="${player.nationality} flag" class="w-16 h-12 rounded-md mb-2">
                    <span class="text-gray-400 text-sm">${player.position}</span>
                </div>
            `;
            const currentBidderName = currentAuction.currentBidderId ? teams.find(t => t.id === currentAuction.currentBidderId)?.name : 'Nadie ha pujado aún';
            bidInfo.innerHTML = `
                <h4 class="text-2xl font-bold text-white text-center">Puja Actual</h4>
                <span class="text-4xl font-extrabold text-green-400">${formatCurrency(currentAuction.currentBid)}</span>
                <p class="text-gray-400">Líder: ${currentBidderName}</p>
            `;
            document.getElementById('timer-display').textContent = `${currentAuction.timer}s`;
            initialBidBtn.textContent = `Pujar ${formatCurrency(currentAuction.player.value)}`;
            hintsLeftSpan.textContent = 2 - currentAuction.hintsUsed;
            hintBtn.disabled = currentAuction.hintsUsed >= 2;
        }

        function checkDraftReadiness() {
            if (teams.length > 0) {
                startDraftBtn.classList.remove('hidden');
            } else {
                startDraftBtn.classList.add('hidden');
            }
        }

        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `p-4 rounded-lg mt-4 text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // Utilidades
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(value);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getFlagUrl(nationality) {
            const flagMap = {
                'ARG': 'https://flagcdn.com/w160/ar.png', 'BRA': 'https://flagcdn.com/w160/br.png', 'ENG': 'https://flagcdn.com/w160/gb-eng.png',
                'ESP': 'https://flagcdn.com/w160/es.png', 'FRA': 'https://flagcdn.com/w160/fr.png', 'GER': 'https://flagcdn.com/w160/de.png',
                'POR': 'https://flagcdn.com/w160/pt.png', 'BEL': 'https://flagcdn.com/w160/be.png', 'NED': 'https://flagcdn.com/w160/nl.png',
                'ITA': 'https://flagcdn.com/w160/it.png', 'URU': 'https://flagcdn.com/w160/uy.png', 'CRO': 'https://flagcdn.com/w160/hr.png',
                'SCO': 'https://flagcdn.com/w160/gb-sct.png', 'CAN': 'https://flagcdn.com/w160/ca.png', 'SUI': 'https://flagcdn.com/w160/ch.png',
                'AUT': 'https://flagcdn.com/w160/at.png', 'SVK': 'https://flagcdn.com/w160/sk.png', 'NOR': 'https://flagcdn.com/w160/no.png',
                'NGA': 'https://flagcdn.com/w160/ng.png', 'EGY': 'https://flagcdn.com/w160/eg.png', 'POL': 'https://flagcdn.com/w160/pl.png',
                'GEO': 'https://flagcdn.com/w160/ge.png', 'KOR': 'https://flagcdn.com/w160/kr.png', 'SRB': 'https://flagcdn.com/w160/rs.png',
                'SLO': 'https://flagcdn.com/w160/si.png', 'CMR': 'https://flagcdn.com/w160/cm.png', 'GHA': 'https://flagcdn.com/w160/gh.png',
                'CIV': 'https://flagcdn.com/w160/ci.png', 'HUN': 'https://flagcdn.com/w160/hu.png',
            };
            return flagMap[nationality] || 'https://flagcdn.com/w160/un.png';
        }
    </script>
</body>
</html>

