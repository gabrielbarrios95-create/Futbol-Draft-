<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Draft Multijugador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        let firebaseConfig, initialAuthToken, appId;
        
        let app, db, auth, userId;
        let unsubscribe;
        let gameRef;
        let localPlayer = {};
        let gameData = {};

        const playersData = [
            { id: 1, name: "Lionel Messi" },
            { id: 2, name: "Cristiano Ronaldo" },
            { id: 3, name: "Neymar Jr" },
            { id: 4, name: "Kylian Mbappé" },
            { id: 5, name: "Kevin De Bruyne" },
            { id: 6, name: "Robert Lewandowski" },
            { id: 7, name: "Virgil van Dijk" },
            { id: 8, name: "Mohamed Salah" },
            { id: 9, name: "Luka Modric" },
            { id: 10, name: "Karim Benzema" }
        ];

        const state = {
            gameStatus: 'lobby',
            players: [],
            hostId: null,
            draftedPlayers: [],
            availablePlayers: [...playersData],
            currentPick: 0,
            lobbyId: '',
            numPlayers: 2
        };

        // --- UI Utility Functions ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showMessage(elementId, message, color = 'text-red-400') {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `${color} text-sm mt-4 text-center`;
        }

        // --- Gemini API Integration for Scouting Report ---
        async function getScoutingReport(playerName) {
            const reportModal = document.getElementById('scoutingReportModal');
            const reportContent = document.getElementById('scoutingReportContent');
            
            reportContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-10">
                    <div class="loader-spinner"></div>
                    <p class="text-gray-400 mt-4">Generando informe...</p>
                </div>
            `;
            reportModal.classList.remove('hidden');

            const systemPrompt = "Actúa como un experto en scouting de fútbol. Proporciona un informe conciso y objetivo sobre el jugador. Incluye su estilo de juego, sus puntos fuertes y una posible debilidad. La respuesta debe ser un solo párrafo y no debe mencionar la fuente.";
            const userQuery = `Crea un informe de scouting para el jugador: ${playerName}`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar el informe. Inténtalo de nuevo.";
                reportContent.textContent = text;
            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                reportContent.textContent = "Hubo un problema al generar el informe. Inténtalo más tarde.";
            }
        }
        
        function closeScoutingReportModal() {
            document.getElementById('scoutingReportModal').classList.add('hidden');
        }

        // --- Lobby and Game Logic ---
        async function createLobby() {
            try {
                const lobbyId = generateLobbyId();
                const path = `artifacts/${appId}/public/data/lobbies/${lobbyId}`;
                gameRef = doc(db, path);
                
                await setDoc(gameRef, {
                    hostId: userId,
                    players: [{ id: userId, name: localPlayer.name, team: 1 }],
                    status: 'lobby',
                    numPlayers: state.numPlayers,
                    draftedPlayers: [],
                    availablePlayers: playersData,
                    currentPick: 0,
                });
                state.lobbyId = lobbyId;
                state.hostId = userId;
                localPlayer.team = 1;
                setupRealtimeListener(gameRef);
                document.getElementById('lobbyIdDisplay').textContent = lobbyId;
                showScreen('lobbyScreen');
            } catch (error) {
                console.error("Error al crear el lobby:", error);
                showMessage('errorMessage', 'Error al crear el lobby. Inténtalo de nuevo.');
            }
        }

        async function joinLobby() {
            try {
                const lobbyId = document.getElementById('lobbyIdInput').value.toUpperCase();
                if (!lobbyId) {
                    showMessage('errorMessage', 'Por favor, ingresa un ID de lobby válido.');
                    return;
                }

                const path = `artifacts/${appId}/public/data/lobbies/${lobbyId}`;
                gameRef = doc(db, path);
                const docSnap = await getDoc(gameRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.status === 'lobby') {
                        if (data.players.length >= data.numPlayers) {
                            showMessage('errorMessage', 'El lobby ya está lleno.');
                            return;
                        }
                        const newPlayer = { id: userId, name: localPlayer.name, team: data.players.length + 1 };
                        data.players.push(newPlayer);
                        localPlayer.team = newPlayer.team;
                        await setDoc(gameRef, data);
                        state.lobbyId = lobbyId;
                        state.hostId = data.hostId;
                        setupRealtimeListener(gameRef);
                        document.getElementById('lobbyIdDisplay').textContent = lobbyId;
                        showScreen('lobbyScreen');
                    } else {
                        showMessage('errorMessage', 'Esta partida ya ha comenzado.');
                    }
                } else {
                    showMessage('errorMessage', 'ID de lobby no encontrado.');
                }
            } catch (error) {
                console.error("Error al unirse al lobby:", error);
                showMessage('errorMessage', 'Error al unirse al lobby. Revisa el ID.');
            }
        }

        function setupRealtimeListener(docRef) {
            if (unsubscribe) {
                unsubscribe();
            }
            unsubscribe = onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    gameData = doc.data();
                    updateUI();
                } else {
                    // Lobby was deleted or doesn't exist
                    showScreen('welcomeScreen');
                    showMessage('errorMessage', 'El lobby ya no existe. Intenta unirte a otra partida o crea una nueva.');
                }
            }, (error) => {
                console.error("Error listening for document changes:", error);
            });
        }

        function updateUI() {
            // Update lobby screen
            const playersList = document.getElementById('playersList');
            if (playersList) {
                playersList.innerHTML = gameData.players.map(p => `
                    <div class="p-2 border border-gray-700 rounded-lg mb-2 bg-gray-700">
                        <p class="text-sm">${p.name} (ID: <span class="text-xs text-blue-400">${p.id.substring(0, 8)}...</span>) - Equipo ${p.team}</p>
                    </div>
                `).join('');
                
                const isHost = gameData.hostId === userId;
                const isLobbyFull = gameData.players.length === gameData.numPlayers;
                document.getElementById('startDraftBtn').classList.toggle('hidden', !isHost || !isLobbyFull);
                document.getElementById('waitingMessage').classList.toggle('hidden', isHost);
                document.getElementById('playerCount').textContent = `${gameData.players.length} / ${gameData.numPlayers} jugadores`;
            }
            
            // Update game screen
            if (gameData.status === 'playing') {
                showScreen('gameScreen');
                const playersPickContainer = document.getElementById('players-pick');
                const nextPlayerTurn = gameData.players.find(p => p.id === gameData.turn);
                if (playersPickContainer) {
                    playersPickContainer.textContent = `Turno de: ${nextPlayerTurn ? nextPlayerTurn.name : '...'}`;
                }

                const availableContainer = document.getElementById('available-players-container');
                availableContainer.innerHTML = '';
                gameData.availablePlayers.forEach(player => {
                    const playerCard = createPlayerCard(player, true);
                    availableContainer.appendChild(playerCard);
                });

                const draftedContainer = document.getElementById('drafted-players-container');
                draftedContainer.innerHTML = '';
                gameData.draftedPlayers.forEach(draftedPlayer => {
                    const player = playersData.find(p => p.id === draftedPlayer.id);
                    const playerInfo = gameData.players.find(p => p.id === draftedPlayer.playerId);
                    if (player && playerInfo) {
                      const playerCard = createPlayerCard(player, false, playerInfo.name);
                      draftedContainer.appendChild(playerCard);
                    }
                });
            } else if (gameData.status === 'lobby') {
                showScreen('lobbyScreen');
            }
        }

        function createPlayerCard(player, isAvailable, draftedBy = null) {
            const card = document.createElement('div');
            card.className = `p-4 border rounded-lg shadow-lg flex flex-col items-center justify-between transition-transform transform ${isAvailable ? 'bg-gray-700 hover:scale-105' : 'bg-gray-800'}`;
            
            const name = document.createElement('h3');
            name.className = 'text-xl font-bold mb-2';
            name.textContent = player.name;
            
            const team = document.createElement('p');
            team.className = 'text-sm text-gray-400';
            if (!isAvailable) {
                team.textContent = `Seleccionado por: ${draftedBy}`;
            }

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex space-x-2 mt-4';
            
            if (isAvailable) {
                const draftButton = document.createElement('button');
                draftButton.className = 'px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors';
                draftButton.textContent = 'Seleccionar';
                draftButton.onclick = () => {
                    if (gameData.turn === userId) {
                        draftPlayer(player.id);
                    } else {
                        console.log("No es tu turno.");
                    }
                };
                buttonContainer.appendChild(draftButton);
            }

            const reportButton = document.createElement('button');
            reportButton.className = 'px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors';
            reportButton.textContent = '✨ Análisis';
            reportButton.onclick = () => getScoutingReport(player.name);
            buttonContainer.appendChild(reportButton);

            card.appendChild(name);
            card.appendChild(team);
            card.appendChild(buttonContainer);
            
            return card;
        }

        async function draftPlayer(playerId) {
            try {
                if (gameRef && gameData.turn === userId) {
                    const updatedAvailable = gameData.availablePlayers.filter(p => p.id !== playerId);
                    const draftedPlayer = gameData.availablePlayers.find(p => p.id === playerId);
                    const newDraftedList = [...gameData.draftedPlayers, {
                        id: draftedPlayer.id,
                        name: draftedPlayer.name,
                        playerId: userId,
                        pickNumber: gameData.currentPick
                    }];
                    
                    const nextPlayerIndex = (gameData.players.findIndex(p => p.id === userId) + 1) % gameData.players.length;
                    const nextPlayerId = gameData.players[nextPlayerIndex].id;

                    await setDoc(gameRef, {
                        ...gameData,
                        availablePlayers: updatedAvailable,
                        draftedPlayers: newDraftedList,
                        currentPick: gameData.currentPick + 1,
                        turn: nextPlayerId
                    });
                }
            } catch (error) {
                console.error("Error al realizar el draft:", error);
            }
        }

        async function startGame() {
            try {
                if (gameRef && gameData.hostId === userId && gameData.players.length === gameData.numPlayers) {
                    const firstPlayer = gameData.players[0].id;
                    await setDoc(gameRef, { ...gameData, status: 'playing', turn: firstPlayer });
                } else {
                    showMessage('errorMessage', 'No puedes iniciar la partida. Asegúrate de que el lobby esté lleno.', 'text-yellow-400');
                }
            } catch (error) {
                console.error("Error al iniciar la partida:", error);
            }
        }

        function generateLobbyId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            firebaseConfig = JSON.parse(typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : '{}');
            initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;
            appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = userId;
                    const userNameInput = document.getElementById('userName');
                    userNameInput.value = `Jugador ${Math.random().toString(36).substring(7, 9).toUpperCase()}`;
                    localPlayer.name = userNameInput.value;
                    userNameInput.addEventListener('change', (e) => { localPlayer.name = e.target.value; });
                    showScreen('setupScreen');
                } else {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });

            document.getElementById('numPlayersSlider').addEventListener('input', (e) => {
                state.numPlayers = parseInt(e.target.value);
                document.getElementById('numPlayersValue').textContent = state.numPlayers;
            });

            document.getElementById('goToWelcomeBtn').addEventListener('click', () => {
                showScreen('welcomeScreen');
            });
            
            document.getElementById('createLobbyBtn').addEventListener('click', createLobby);
            document.getElementById('joinLobbyBtn').addEventListener('click', joinLobby);
            document.getElementById('startDraftBtn').addEventListener('click', startGame);
        });

    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container {
            max-width: 1000px;
            margin: auto;
        }
        .loader-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 flex flex-col items-center justify-center">

    <div id="loading" class="screen flex flex-col items-center justify-center">
        <div class="loader-spinner"></div>
        <p class="mt-4 text-gray-400">Cargando...</p>
    </div>

    <!-- Pantalla de Configuración -->
    <div id="setupScreen" class="screen hidden w-full max-w-lg bg-gray-800 p-8 rounded-xl shadow-2xl space-y-6 text-center">
        <h1 class="text-3xl font-extrabold text-blue-400 mb-2">Configuración de Partida</h1>
        <p class="text-gray-400">Selecciona cuántos jugadores participarán en el draft.</p>
        
        <div class="flex flex-col items-center space-y-4">
            <span id="numPlayersValue" class="text-6xl font-extrabold text-blue-300">2</span>
            <input type="range" id="numPlayersSlider" min="2" max="10" value="2" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
        </div>

        <button id="goToWelcomeBtn" class="w-full p-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition-all duration-300 transform hover:scale-105">Siguiente</button>
    </div>

    <!-- Pantalla de Bienvenida -->
    <div id="welcomeScreen" class="screen hidden w-full max-w-lg bg-gray-800 p-8 rounded-xl shadow-2xl space-y-6">
        <div class="text-center">
            <h1 class="text-3xl font-extrabold text-blue-400 mb-2">Juego de Draft Multijugador</h1>
            <p class="text-gray-400">Tu ID de usuario: <span id="userIdDisplay" class="text-sm font-mono text-blue-300"></span></p>
        </div>

        <div class="flex flex-col space-y-4">
            <input id="userName" type="text" placeholder="Tu Nombre" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="createLobbyBtn" class="w-full p-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition-all duration-300 transform hover:scale-105">Crear Partida</button>
        </div>
        
        <div class="relative flex items-center py-5">
            <div class="flex-grow border-t border-gray-600"></div>
            <span class="flex-shrink mx-4 text-gray-400">o unirte a una existente</span>
            <div class="flex-grow border-t border-gray-600"></div>
        </div>

        <div class="flex flex-col space-y-4">
            <input id="lobbyIdInput" type="text" placeholder="ID de Partida" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
            <button id="joinLobbyBtn" class="w-full p-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold transition-all duration-300 transform hover:scale-105">Unirse a Partida</button>
        </div>

        <p id="errorMessage" class="text-red-400 text-sm mt-4 text-center"></p>
    </div>

    <!-- Pantalla de Lobby -->
    <div id="lobbyScreen" class="screen hidden w-full max-w-lg bg-gray-800 p-8 rounded-xl shadow-2xl space-y-6">
        <h2 class="text-2xl font-bold text-center">Lobby de Partida</h2>
        <p id="playerCount" class="text-center text-gray-400"></p>
        <p class="text-center text-gray-400">Comparte este ID con tus amigos:</p>
        <p id="lobbyIdDisplay" class="text-center text-4xl font-extrabold text-blue-400 tracking-wider bg-gray-700 p-4 rounded-lg select-all">...</p>
        
        <div id="playersList" class="space-y-2 max-h-48 overflow-y-auto">
            <!-- Los jugadores se renderizarán aquí -->
        </div>
        
        <div class="flex justify-center mt-6">
            <button id="startDraftBtn" class="p-3 px-6 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition-all duration-300 transform hover:scale-105 hidden">Comenzar Draft</button>
        </div>
        <p id="waitingMessage" class="text-center text-gray-400 mt-4">Esperando que el anfitrión comience el draft...</p>
    </div>

    <!-- Pantalla de Juego -->
    <div id="gameScreen" class="screen hidden w-full container grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">

        <!-- Columna de Jugadores Disponibles -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
            <h2 class="text-3xl font-extrabold text-white mb-4 text-center">Jugadores Disponibles</h2>
            <p id="players-pick" class="text-lg text-yellow-400 font-bold mb-4 text-center"></p>
            <div id="available-players-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto">
                <!-- Los jugadores disponibles se renderizarán aquí -->
            </div>
        </div>

        <!-- Columna de Jugadores Seleccionados -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
            <h2 class="text-3xl font-extrabold text-white mb-4 text-center">Jugadores Seleccionados</h2>
            <div id="drafted-players-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto">
                <!-- Los jugadores seleccionados se renderizarán aquí -->
            </div>
        </div>
    </div>

    <!-- Modal para el informe de scouting -->
    <div id="scoutingReportModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                <h3 class="text-2xl font-bold">Informe de Jugador</h3>
                <button onclick="closeScoutingReportModal()" class="text-gray-400 hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <div id="scoutingReportContent" class="text-gray-300 text-sm leading-relaxed max-h-96 overflow-y-auto">
                <!-- El contenido del informe se cargará aquí -->
            </div>
        </div>
    </div>
</body>
</html>
